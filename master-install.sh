#!/bin/bash

###############################################################################
# 🍰 Bakery ERP v4.1 - MASTER INSTALLER
# Полная установка с рабочими страницами
###############################################################################

set -e

echo "🍰 Bakery ERP v4.1 - MASTER INSTALLER"
echo "======================================"
echo ""
echo "Этот скрипт установит:"
echo "  ✅ Базовую систему (Docker + Backend + Frontend)"
echo "  ✅ Все функциональные страницы"
echo "  ✅ CRUD для всех модулей"
echo ""
read -p "Продолжить? (y/n) " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Отменено"
    exit 1
fi

###############################################################################
# ШАГ 1: Запуск базовой установки
###############################################################################

echo ""
echo "📦 Шаг 1/4: Установка базовой системы..."
echo ""

if [ -f "./install-v4-complete.sh" ]; then
    chmod +x ./install-v4-complete.sh
    ./install-v4-complete.sh
else
    echo "❌ Файл install-v4-complete.sh не найден!"
    echo "Скачайте его из [78] и поместите в текущую директорию"
    exit 1
fi

###############################################################################
# ШАГ 2: Добавление страниц Part 1
###############################################################################

echo ""
echo "📄 Шаг 2/4: Добавление Clients & Suppliers..."
echo ""

if [ -f "./add-pages-part1.sh" ]; then
    chmod +x ./add-pages-part1.sh
    ./add-pages-part1.sh
else
    echo "⚠️  add-pages-part1.sh не найден, пропускаем..."
fi

###############################################################################
# ШАГ 3: Добавление страниц Part 2
###############################################################################

echo ""
echo "📄 Шаг 3/4: Добавление Components & Products & Recipes..."
echo ""

if [ -f "./add-pages-part2.sh" ]; then
    chmod +x ./add-pages-part2.sh
    ./add-pages-part2.sh
else
    echo "⚠️  add-pages-part2.sh не найден, пропускаем..."
fi

###############################################################################
# ШАГ 4: Добавление страниц Part 3
###############################################################################

echo ""
echo "📄 Шаг 4/4: Добавление Orders + обновление App.js..."
echo ""

if [ -f "./add-pages-part3.sh" ]; then
    chmod +x ./add-pages-part3.sh
    ./add-pages-part3.sh
else
    echo "⚠️  add-pages-part3.sh не найден, пропускаем..."
fi

###############################################################################
# ФИНАЛ: Запуск системы
###############################################################################

echo ""
echo "🚀 Запуск системы..."
echo ""

# Остановка старых контейнеров
docker compose down 2>/dev/null || true

# Запуск новых
docker compose up -d --build

echo ""
echo "✅ УСТАНОВКА ЗАВЕРШЕНА!"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "🎉 Bakery ERP v4.1 успешно установлена!"
echo ""
echo "📋 Что работает:"
echo "   ✅ Клиенты - полный CRUD (добавить, редактировать, удалить)"
echo "   ✅ Поставщики - добавление и просмотр"
echo "   ✅ Компоненты - добавление и просмотр"
echo "   ✅ Рецепты - добавление и просмотр"
echo "   ✅ Товары - добавление и просмотр"
echo "   ✅ Замовлення - создание и просмотр"
echo ""
echo "🌐 Откройте в браузере:"
echo "   http://localhost"
echo ""
echo "🔑 Логин:"
echo "   Логін: admin"
echo "   Пароль: admin"
echo ""
echo "📊 Проверка статуса:"
echo "   docker compose ps"
echo ""
echo "📝 Логи:"
echo "   docker compose logs -f backend"
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
