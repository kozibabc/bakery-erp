# üç∞ Bakery ERP v4.2.1 - –£–ø–∞–∫–æ–≤–∫–∞ + –°–ø–∏—Å–∞–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞

## üìã –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ v4.2.1

### ‚úÖ **–£–ø–∞–∫–æ–≤–∫–∞ –≤ —Ç–æ–≤–∞—Ä–µ**
- –¢–æ–≤–∞—Ä —Ç–µ–ø–µ—Ä—å = **–†–µ—Ü–µ–ø—Ç + –£–ø–∞–∫–æ–≤–∫–∞ + –í–µ—Å**
- –£–ø–∞–∫–æ–≤–∫–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —Ä–µ—Ü–µ–ø—Ç–∞
- –ú–æ–∂–Ω–æ –∑–∞–∫—É–ø–∞—Ç—å —É–ø–∞–∫–æ–≤–∫—É (–∫–æ—Ä–æ–±–∫–∏, –ø–ª—ë–Ω–∫—É)

### ‚úÖ **–°–ø–∏—Å–∞–Ω–∏–µ —Å–æ —Å–∫–ª–∞–¥–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞**
- –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–í–∏–∫–æ–Ω–∞—Ç–∏" –∑–∞–∫–∞–∑:
  1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —Ä–µ—Ü–µ–ø—Ç–∞–º (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ!)
  2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è —É–ø–∞–∫–æ–≤–∫–∞
  3. –í—Å—ë —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å–∫–ª–∞–¥–∞
  4. –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ ProductionUsage

---

## üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# 1. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –ø–∞—Ç—á
chmod +x patch-v4.2.1.sh
./patch-v4.2.1.sh

# 2. –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ
docker compose down
docker compose up -d --build
```

---

## üìä –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ Product

```javascript
{
  "name": "–†–æ–º–∞—à–∫–∞ 2.5 –∫–≥",
  "recipeId": 5,                    // –†–µ—Ü–µ–ø—Ç –ø–µ—á–µ–Ω—å—è
  "boxNetWeight": 2.5,              // –ù–µ—Ç—Ç–æ –∫–æ—Ä–æ–±–∫–∏
  "boxGrossWeight": 2.7,            // –ë—Ä—É—Ç—Ç–æ –∫–æ—Ä–æ–±–∫–∏
  "packagingComponentId": 15,       // NEW! ID –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —É–ø–∞–∫–æ–≤–∫–∏
  "packagingQty": 1,                // NEW! –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–ø–∞–∫–æ–≤–∫–∏ –Ω–∞ 1 –∫–æ—Ä–æ–±–∫—É
  ...
}
```

---

## üéØ Workflow –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### **–®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —É–ø–∞–∫–æ–≤–∫—É –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç**

```javascript
// –°–æ–∑–¥–∞—ë–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç "–ö–æ—Ä–æ–±–∫–∞ –∫–∞—Ä—Ç–æ–Ω–Ω–∞—è"
POST /api/components
{
  "name": "–ö–æ—Ä–æ–±–∫–∞ –∫–∞—Ä—Ç–æ–Ω–Ω–∞—è 2.5–∫–≥",
  "type": "PACK",
  "unit": "—à—Ç"
}
// ‚Üí ID = 15
```

### **–®–∞–≥ 2: –ó–∞–∫—É–ø–∏—Ç—å —É–ø–∞–∫–æ–≤–∫—É**

```javascript
// –ó–∞–∫—É–ø–∞–µ–º –∫–æ—Ä–æ–±–∫–∏
POST /api/purchases
{
  "componentId": 15,          // –ö–æ—Ä–æ–±–∫–∞
  "qty": 1000,                // 1000 —à—Ç—É–∫
  "pricePerUnit": 5,          // 5 –≥—Ä–Ω/—à—Ç
  "supplierId": 2
}

// ‚Üí –°–∫–ª–∞–¥ –æ–±–Ω–æ–≤–ª—ë–Ω:
// –ö–æ—Ä–æ–±–∫–∏: 1000 —à—Ç √ó 5 –≥—Ä–Ω/—à—Ç
```

### **–®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä —Å —É–ø–∞–∫–æ–≤–∫–æ–π**

```javascript
// –°–æ–∑–¥–∞—ë–º —Ç–æ–≤–∞—Ä
POST /api/products
{
  "name": "–†–æ–º–∞—à–∫–∞ 2.5 –∫–≥",
  "recipeId": 5,                    // –†–µ—Ü–µ–ø—Ç –ø–µ—á–µ–Ω—å—è
  "boxNetWeight": 2.5,              // 2.5 –∫–≥ –Ω–µ—Ç—Ç–æ
  "boxGrossWeight": 2.7,            // 2.7 –∫–≥ –±—Ä—É—Ç—Ç–æ
  "packagingComponentId": 15,       // –ö–æ—Ä–æ–±–∫–∞
  "packagingQty": 1                 // 1 –∫–æ—Ä–æ–±–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä
}

// –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –°—á–∏—Ç–∞–µ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ—Ü–µ–ø—Ç–∞ √ó 2.5 –∫–≥
// 2. –î–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ—Ä–æ–±–∫–∏ (5 –≥—Ä–Ω)
// 3. –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ
// 4. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—ã (–æ–ø—Ç/—Ä–æ–∑–Ω1/—Ä–æ–∑–Ω2)
```

### **–®–∞–≥ 4: –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑**

```javascript
// –°–æ–∑–¥–∞—ë–º –∑–∞–∫–∞–∑
POST /api/orders
{
  "orderNumber": "ORD-123",
  "clientId": 1
}

// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏
POST /api/orders/1/items
{
  "productId": 8,        // –†–æ–º–∞—à–∫–∞ 2.5 –∫–≥
  "boxes": 10,           // 10 –∫–æ—Ä–æ–±–æ–∫
  "unitPrice": 250
}
```

### **–®–∞–≥ 5: –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑ (–°–ü–ò–°–ê–ù–ò–ï!)**

```javascript
// –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–∫–∞–∑
POST /api/orders/1/complete

// –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
// 1. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø–æ —Ä–µ—Ü–µ–ø—Ç—É "–ü–µ—á–µ–Ω—å–µ":
//    - –ï—Å–ª–∏ —Ä–µ—Ü–µ–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç "–¢–µ—Å—Ç–æ" (SEMI_OWN)
//    - –¢–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Ä–µ—Ü–µ–ø—Ç "–¢–µ—Å—Ç–æ" ‚Üí –º—É–∫–∞, —Å–∞—Ö–∞—Ä, –º–∞—Å–ª–æ
//    - –ò —Ç–∞–∫ –ø–æ –≤—Å–µ–º —É—Ä–æ–≤–Ω—è–º!
//
// 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —É–ø–∞–∫–æ–≤–∫—É:
//    - 10 –∫–æ—Ä–æ–±–æ–∫ √ó 1 —à—Ç = 10 –∫–æ—Ä–æ–±–æ–∫
//
// 3. –°–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ —Å–∫–ª–∞–¥–∞:
//    - –ú—É–∫–∞: -15 –∫–≥
//    - –°–∞—Ö–∞—Ä: -5 –∫–≥
//    - –ú–∞—Å–ª–æ: -5 –∫–≥
//    - –ö–æ—Ä–æ–±–∫–∏: -10 —à—Ç
//
// 4. –õ–æ–≥–∏—Ä—É–µ—Ç –≤ ProductionUsage
// 5. –û–±–Ω–æ–≤–ª—è–µ—Ç –∑–∞–∫–∞–∑: status='done', totalCost, profit

// –û—Ç–≤–µ—Ç:
{
  "success": true,
  "materials": [
    { "componentId": 1, "name": "–ú—É–∫–∞", "qty": 15 },
    { "componentId": 2, "name": "–°–∞—Ö–∞—Ä", "qty": 5 },
    { "componentId": 3, "name": "–ú–∞—Å–ª–æ", "qty": 5 },
    { "componentId": 15, "name": "–ö–æ—Ä–æ–±–∫–∞", "qty": 10 }
  ],
  "totalCost": 1250.00,
  "profit": 1250.00
}
```

### **–®–∞–≥ 6: –ü—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞ —Å–ø–∏—Å–∞–Ω–∏—è**

```javascript
// –ü–æ–ª—É—á–∏—Ç—å –∂—É—Ä–Ω–∞–ª —Å–ø–∏—Å–∞–Ω–∏—è –ø–æ –∑–∞–∫–∞–∑—É
GET /api/orders/1/usage

// –û—Ç–≤–µ—Ç:
[
  {
    "componentId": 1,
    "Component": { "name": "–ú—É–∫–∞" },
    "qtyUsed": 15.000,
    "costPerUnit": 25.00,
    "totalCost": 375.00
  },
  {
    "componentId": 2,
    "Component": { "name": "–°–∞—Ö–∞—Ä" },
    "qtyUsed": 5.000,
    "costPerUnit": 30.00,
    "totalCost": 150.00
  },
  ...
]
```

---

## üî• –ü—Ä–∏–º–µ—Ä: –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã + –£–ø–∞–∫–æ–≤–∫–∞

### **–†–µ—Ü–µ–ø—Ç "–¢–µ—Å—Ç–æ –ø–µ—Å–æ—á–Ω–æ–µ" (–Ω–∞ 1 –∫–≥):**
```
- –ú—É–∫–∞: 0.6 –∫–≥ √ó 25 –≥—Ä–Ω/–∫–≥ = 15 –≥—Ä–Ω
- –°–∞—Ö–∞—Ä: 0.2 –∫–≥ √ó 30 –≥—Ä–Ω/–∫–≥ = 6 –≥—Ä–Ω
- –ú–∞—Å–ª–æ: 0.2 –∫–≥ √ó 85 –≥—Ä–Ω/–∫–≥ = 17 –≥—Ä–Ω
‚Üí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–µ—Å—Ç–∞ = 38 –≥—Ä–Ω/–∫–≥
```

### **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç "–¢–µ—Å—Ç–æ –ø–µ—Å–æ—á–Ω–æ–µ" (SEMI_OWN):**
```
type: SEMI_OWN
linkedRecipeId: 1  // –†–µ—Ü–µ–ø—Ç —Ç–µ—Å—Ç–∞
```

### **–†–µ—Ü–µ–ø—Ç "–ü–µ—á–µ–Ω—å–µ –†–æ–º–∞—à–∫–∞" (–Ω–∞ 1 –∫–≥):**
```
- –¢–µ—Å—Ç–æ –ø–µ—Å–æ—á–Ω–æ–µ: 0.8 –∫–≥ √ó 38 –≥—Ä–Ω/–∫–≥ = 30.4 –≥—Ä–Ω  (–±–µ—Ä—ë—Ç—Å—è –∏–∑ —Ä–µ—Ü–µ–ø—Ç–∞!)
- –ü–æ–≤–∏–¥–ª–æ: 0.15 –∫–≥ √ó 40 –≥—Ä–Ω/–∫–≥ = 6 –≥—Ä–Ω
- –ì–ª–∞–∑—É—Ä—å: 0.05 –∫–≥ √ó 95 –≥—Ä–Ω/–∫–≥ = 4.75 –≥—Ä–Ω
‚Üí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–µ—á–µ–Ω—å—è = 41.15 –≥—Ä–Ω/–∫–≥
```

### **–¢–æ–≤–∞—Ä "–†–æ–º–∞—à–∫–∞ 2.5 –∫–≥":**
```
- –†–µ—Ü–µ–ø—Ç: "–ü–µ—á–µ–Ω—å–µ –†–æ–º–∞—à–∫–∞"
- –ù–µ—Ç—Ç–æ: 2.5 –∫–≥
- –£–ø–∞–∫–æ–≤–∫–∞: "–ö–æ—Ä–æ–±–∫–∞" (5 –≥—Ä–Ω)

–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å:
  = 41.15 √ó 2.5 + 5
  = 102.875 + 5
  = 107.875 –≥—Ä–Ω

–° –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ (15%):
  = 107.875 √ó 1.15
  = 124.06 –≥—Ä–Ω

–¶–µ–Ω—ã:
  - –û–ø—Ç (+10%): 136.47 –≥—Ä–Ω
  - –†–æ–∑–Ω1 (+40%): 173.68 –≥—Ä–Ω
  - –†–æ–∑–Ω2 (+70%): 210.90 –≥—Ä–Ω
```

### **–ó–∞–∫–∞–∑: 10 –∫–æ—Ä–æ–±–æ–∫ "–†–æ–º–∞—à–∫–∞ 2.5 –∫–≥"**

–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è:
```
–†–µ—Ü–µ–ø—Ç "–ü–µ—á–µ–Ω—å–µ" —Ç—Ä–µ–±—É–µ—Ç:
  ‚Üí "–¢–µ—Å—Ç–æ –ø–µ—Å–æ—á–Ω–æ–µ" 0.8 –∫–≥ √ó 2.5 –∫–≥ √ó 10 = 20 –∫–≥ —Ç–µ—Å—Ç–∞

–¢–µ—Å—Ç–æ —Ç—Ä–µ–±—É–µ—Ç (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ!):
  ‚Üí –ú—É–∫–∞: 20 √ó 0.6 = 12 –∫–≥
  ‚Üí –°–∞—Ö–∞—Ä: 20 √ó 0.2 = 4 –∫–≥
  ‚Üí –ú–∞—Å–ª–æ: 20 √ó 0.2 = 4 –∫–≥

–î—Ä—É–≥–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
  ‚Üí –ü–æ–≤–∏–¥–ª–æ: 0.15 √ó 2.5 √ó 10 = 3.75 –∫–≥
  ‚Üí –ì–ª–∞–∑—É—Ä—å: 0.05 √ó 2.5 √ó 10 = 1.25 –∫–≥

–£–ø–∞–∫–æ–≤–∫–∞:
  ‚Üí –ö–æ—Ä–æ–±–∫–∏: 10 —à—Ç

–ò–¢–û–ì–û —Å–ø–∏—Å–∞–Ω–∏–µ:
  - –ú—É–∫–∞: 12 –∫–≥
  - –°–∞—Ö–∞—Ä: 4 –∫–≥
  - –ú–∞—Å–ª–æ: 4 –∫–≥
  - –ü–æ–≤–∏–¥–ª–æ: 3.75 –∫–≥
  - –ì–ª–∞–∑—É—Ä—å: 1.25 –∫–≥
  - –ö–æ—Ä–æ–±–∫–∏: 10 —à—Ç
```

---

## üéØ –ù–æ–≤—ã–µ API endpoints

### **–í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–∫–∞–∑ —Å —Å–ø–∏—Å–∞–Ω–∏–µ–º:**
```
POST /api/orders/:id/complete
‚Üí { success: true, materials: [...], totalCost, profit }
```

### **–ü–æ–ª—É—á–∏—Ç—å –∂—É—Ä–Ω–∞–ª —Å–ø–∏—Å–∞–Ω–∏—è:**
```
GET /api/orders/:id/usage
‚Üí [{ componentId, qtyUsed, costPerUnit, totalCost }, ...]
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

```bash
# 1. –°–æ–∑–¥–∞–π—Ç–µ —É–ø–∞–∫–æ–≤–∫—É
curl -X POST http://localhost:3000/api/components \
  -H "Authorization: Bearer TOKEN" \
  -d '{"name":"–ö–æ—Ä–æ–±–∫–∞","type":"PACK","unit":"—à—Ç"}'

# 2. –ó–∞–∫—É–ø–∏—Ç–µ —É–ø–∞–∫–æ–≤–∫—É
curl -X POST http://localhost:3000/api/purchases \
  -H "Authorization: Bearer TOKEN" \
  -d '{"componentId":15,"qty":100,"pricePerUnit":5,"supplierId":1}'

# 3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–≤–∞—Ä —Å —É–ø–∞–∫–æ–≤–∫–æ–π
curl -X POST http://localhost:3000/api/products \
  -H "Authorization: Bearer TOKEN" \
  -d '{"name":"–¢–æ–≤–∞—Ä","recipeId":1,"boxNetWeight":2.5,"packagingComponentId":15,"packagingQty":1}'

# 4. –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–∫–∞–∑ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ
curl -X POST http://localhost:3000/api/orders/1/complete \
  -H "Authorization: Bearer TOKEN"
```

---

## üö® –í–∞–∂–Ω–æ

1. **MRP —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ** - —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ —É—Ä–æ–≤–Ω–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤
2. **–ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–æ–≤** - –µ—Å–ª–∏ —Ä–µ—Ü–µ–ø—Ç A ‚Üí B ‚Üí A, —Ç–æ –≤–µ—Ä–Ω—ë—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
3. **–£–ø–∞–∫–æ–≤–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ** - –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Ä–µ—Ü–µ–ø—Ç, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ —Ç–æ–≤–∞—Ä—É
4. **–°–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ** - stock.qtyOnHand —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è
5. **–õ–æ–≥ –≤ ProductionUsage** - –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –±—ã–ª–æ —Å–ø–∏—Å–∞–Ω–æ

---

**v4.2.1 - –ø–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –≥–æ—Ç–æ–≤–∞!** üöÄ
